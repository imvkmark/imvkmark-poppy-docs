import{_ as e,o as s,c as o,b as d}from"./app.d1bf96cf.js";const n={},a=d(`<h1 id="_3-2-4-0-\u5347\u7EA7\u8BF4\u660E" tabindex="-1"><a class="header-anchor" href="#_3-2-4-0-\u5347\u7EA7\u8BF4\u660E" aria-hidden="true">#</a> 3.2 -&gt; 4.0 \u5347\u7EA7\u8BF4\u660E</h1><h2 id="\u5EFA\u8BAE" tabindex="-1"><a class="header-anchor" href="#\u5EFA\u8BAE" aria-hidden="true">#</a> \u5EFA\u8BAE</h2><ul><li>\u4F7F\u7528 <code>Guzzle\\Client</code> \u66FF\u4EE3\u6389 <code>Curl\\Curl</code>, \u5199\u6CD5\u7B49\u5747\u9700\u8981\u53D8\u52A8</li></ul><h2 id="framework" tabindex="-1"><a class="header-anchor" href="#framework" aria-hidden="true">#</a> Framework</h2><ul><li><strong>\u4E0D\u517C\u5BB9</strong></li></ul><p>\u79FB\u9664 <code>x_app</code> \u51FD\u6570, \u6B64\u51FD\u6570\u5728 3.2 \u4E2D\u5E9F\u5F03, \u56E0\u4E3A nginx \u65E0\u6CD5\u4ECE json \u4E2D\u83B7\u53D6\u9700\u8981\u7684\u6570\u636E, \u9700\u8981\u663E\u5F0F\u4F7F\u7528 <code>x_header</code> \u6765\u83B7\u53D6</p><p>todo : \u5173\u4E8E Header \u7684\u5B9A\u4E49\u9700\u8981\u5B8C\u5584</p><p><code>jwt_token</code> \u65B9\u6CD5\u53D6\u6D88\u53C2\u6570\u4F20\u9012, \u4F7F\u7528 jwt \u7684 <code>tymon.jwt</code> \u6765\u83B7\u53D6</p><p><code>[2022-06-10]</code> \u4E3B ServiceProvider <code>\\Poppy\\Framework\\Support\\PoppyServiceProvider</code> \u53D8\u91CF <code>$listens</code> \u548C <code>$policies</code> \u4F7F\u7528 array \u5F3A\u7C7B\u578B\u6A21\u5F0F</p><ul><li><strong>\u53EF\u66FF\u4EE3</strong></li></ul><p>\u79FB\u9664 <code>TestCase-&gt;poppyContainer()</code> \u65B9\u6CD5, \u4F7F\u7528 <code>Container::getInstance()</code> \u66FF\u4EE3</p><p>\u79FB\u9664 <code>Resp-&gt;data()</code> \u65B9\u6CD5, \u4F7F\u7528 <code>Resp-&gt;custom()</code> \u66FF\u4EE3</p><p>\u79FB\u9664 <code>get(), post()</code> \u65B9\u6CD5, \u4F7F\u7528 <code>input()</code> \u66FF\u4EE3</p><ul><li><strong>\u8C03\u6574</strong></li></ul><p><code>[2022-06-10]</code> \u5BF9\u4E8E\u540E\u7F6E\u52A0\u8F7D\u7684 ServiceProvider, \u9700\u8981\u7EE7\u627F <code>\\Illuminate\\Contracts\\Support\\DeferrableProvider</code> \u7C7B, \u53D6\u6D88 <code>$defer</code> \u5C5E\u6027</p><h2 id="core" tabindex="-1"><a class="header-anchor" href="#core" aria-hidden="true">#</a> Core</h2><ul><li><strong>\u4E0D\u517C\u5BB9</strong></li></ul><p>\u56E0\u4E3A apidoc \u5347\u7EA7\u5BFC\u81F4\u65E0\u6CD5\u751F\u6210 json , mgr-page \u4E2D\u65E0\u6CD5\u4F7F\u7528\u65B0\u7248\u6765\u751F\u6210 apidoc \u6587\u6863, \u5FC5\u987B\u4F7F\u7528\u65B0\u7248\u672C\u624D\u53EF\u4EE5\u89E3\u6790 json \u6570\u636E, \u4F7F\u7528 js <code>eval</code> \u6765\u89E3\u6790</p><p><code>ServiceArray</code> \u6539\u52A8 <code>key()</code> \u65B9\u6CD5\u9700\u8981\u5F3A\u5236\u8FD4\u56DE <code>string</code></p><ul><li><strong>\u53EF\u66FF\u4EE3</strong></li></ul><p>\u56E0\u4E3A sami \u7EF4\u62A4, \u65E0\u6CD5\u751F\u6210\u65B0\u7248\u672C php api \u6587\u6863, \u4F7F\u7528 doctum \u66FF\u4EE3 sami, \u63A5\u53E3\u4E0D\u53D8, \u53EF\u91CD\u65B0\u751F\u6210</p><p>\u79FB\u9664 <code>RdsNative-&gt;delTaggedKeys()</code> , \u4F7F\u7528 <code>RdsNative-&gt;del()</code> \u66FF\u4EE3</p><p>\u79FB\u9664 <code>sys_success()</code> \u65B9\u6CD5, \u4F7F\u7528 <code>sys_info()</code> \u66FF\u4EE3</p><h2 id="system" tabindex="-1"><a class="header-anchor" href="#system" aria-hidden="true">#</a> System</h2><ul><li><strong>\u4E0D\u517C\u5BB9</strong></li></ul><p><code>ApiSignContract</code> \u65B9\u6CD5 <code>sign</code> \u589E\u52A0\u53C2\u6570 <code>$type</code> , \u4F7F\u8BE5\u65B9\u6CD5\u540C\u65F6\u652F\u6301\u4E0D\u540C\u7AEF\u7B7E\u540D</p><div class="language-diff ext-diff line-numbers-mode"><pre class="language-diff"><code>class DefaultApiSignProvider extends DefaultBaseApiSign
{
<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    public function sign(array $params): string
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    public function sign(array $params, $type = &#39;user&#39;): string
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   {
</span><span class="token prefix unchanged"> </span><span class="token line">       ...
</span><span class="token prefix unchanged"> </span><span class="token line">   }
</span></span>}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u79FB\u9664 <code>SettingRepository</code> \u7684 <code>setReRead()</code>, <code>save()</code> \u65B9\u6CD5</p><p>\u6B64\u65B9\u6CD5 <code>3.2</code> \u5DF2\u7ECF\u91CD\u65B0\u6539\u5199\u4E3A\u4ECE\u7F13\u5B58\u76F4\u63A5\u8BFB\u53D6, \u4E0D\u4F7F\u7528\u9759\u6001\u53D8\u91CF</p><p>\u79FB\u9664 <code>pages.yaml</code> \u7684\u5B9A\u4E49\u4EE5\u53CA\u8BFB\u53D6, \u6539\u7528 mgr-page/mgr-app \u7684 Form \u5199\u6CD5</p><p>\u76F8\u5173\u5F71\u54CD : <code>Module-&gt;pages()</code>, <code>Module/Repositories/ModulesPage</code>, <code>ModuleManager-&gt;pages()</code></p><p>\u79FB\u9664 <code>settings.yaml</code> \u7684\u5B9A\u4E49\u4EE5\u53CA\u8BFB\u53D6, \u4E0D\u652F\u6301\u9879\u76EE\u9ED8\u8BA4\u6570\u636E\u5728 <code>settings.yaml</code> \u7684\u5B9A\u4E49</p><p>\u76F8\u5173\u5F71\u54CD : <code>Module/Repositories/ModulesSetting</code>, <code>ModuleManager-&gt;settings()</code></p><p>\u79FB\u9664 <code>ui.yaml</code> \u7684\u5B9A\u4E49\u4EE5\u53CA\u8BFB\u53D6, \u4E0D\u652F\u6301\u9879\u76EE\u9ED8\u8BA4\u6570\u636E\u5728 <code>ui.yaml</code> \u7684\u5B9A\u4E49</p><p>\u76F8\u5173\u5F71\u54CD : \u79FB\u9664 <code>Module/Repositories/ModulesUi</code>, \u79FB\u9664 <code>ModuleManager-&gt;uis()</code>, \u79FB\u9664 <code>Classes\\Contracts\\UiContract</code></p><p>\u79FB\u9664 <code>ModuleManager-&gt;getExcepts()</code> \u7684\u5B9A\u4E49\u4EE5\u53CA\u8BFB\u53D6(\u65E0\u76F8\u5173\u7528\u9014)</p><p>\u79FB\u9664 <code>\\Poppy\\System\\Action\\Pam::setPasswordById</code>, \u4F7F\u7528 <code>\\Poppy\\System\\Action\\Pam::setPassword</code> \u66FF\u4EE3, \u53C2\u6570\u4E0D\u4E00\u81F4, \u9700\u8981\u6CE8\u610F</p><p>\u79FB\u9664 <code>\\Poppy\\System\\Classes\\Contracts\\UploadContract::type</code> , \u4F7F\u7528 <code>\\Poppy\\System\\Classes\\Uploader\\Uploader::kvExt</code> \u66FF\u4EE3, \u53C2\u6570\u6709\u5DEE\u5F02</p><p>\u79FB\u9664 <code>\\Poppy\\System\\Action\\Pam::captchaLogin</code> , \u53C2\u6570 <code>platform</code> \u66FF\u6362\u4E3A guard \u7C7B\u578B, <code>platform</code> \u4ECE header \u4E2D\u8FDB\u884C\u53D6\u503C</p><p>\u79FB\u9664</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>\\Poppy\\System\\Models\\PamAccount::fetch()             :  \u591A\u4F59\u7684\u5B57\u6BB5\u67E5\u8BE2
\\Poppy\\System\\Models\\PamAccount::getIdByUsername()   :  \u9891\u7387\u4F4E, \u65E0\u7528\u51FD\u6570
\\Poppy\\System\\Models\\PamAccount::getTypeById()       :  \u9891\u7387\u4F4E, \u65E0\u7528\u51FD\u6570
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Pam \u4E2D loginCheck \u79FB\u9664 loginAllowIpCheck \u65B9\u6CD5(\u6B21\u7EA7\u522B\u8C03\u7528), \u4F1A\u5F71\u54CD(ydl) \u9879\u76EE, \u79FB\u9664 <code>\\System\\Events\\LoginSuccessEvent</code> \u8C03\u7528\u65B9\u6CD5</p><div class="language-diff ext-diff line-numbers-mode"><pre class="language-diff"><code>public function loginCheck(string $passport, string $password, string $guard_name = PamAccount::GUARD_WEB): bool
{

<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">        event(new LoginBannedEvent($pam, $guard));
</span></span>
<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">        if (method_exists($this, &#39;loginAllowIpCheck&#39;) &amp;&amp; !$this-&gt;loginAllowIpCheck()) {
</span><span class="token prefix deleted">-</span><span class="token line">            $guard-&gt;logout();
</span><span class="token prefix deleted">-</span><span class="token line">            return false;
</span><span class="token prefix deleted">-</span><span class="token line">       }
</span></span>
<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">        // \u517C\u5BB9\u5B58\u5728 system \u6A21\u5757\u4E8B\u4EF6
</span><span class="token prefix deleted">-</span><span class="token line">        // deprecated \u4E3A\u4E86\u517C\u5BB9 q2
</span><span class="token prefix deleted">-</span><span class="token line">        if (class_exists(&#39;\\System\\Events\\LoginSuccessEvent&#39;)) {
</span><span class="token prefix deleted">-</span><span class="token line">            event(new \\System\\Events\\LoginSuccessEvent($pam, $platform, $guard));
</span><span class="token prefix deleted">-</span><span class="token line">            return true;
</span><span class="token prefix deleted">-</span><span class="token line">        }
</span></span>...
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>\u53EF\u66FF\u4EE3</strong></li></ul><p>\u79FB\u9664 <code>ModuleManager-&gt;repository()</code>, \u4F7F\u7528 <code>ModuleManager-&gt;modules()</code> \u66FF\u4EE3</p><p>\u79FB\u9664 <code>sys_container</code>, \u4F7F\u7528 <code>py_container</code> \u66FF\u4EE3</p><p>\u79FB\u9664 <code>\\Poppy\\System\\Classes\\Abstracts\\SysRouteServiceProvider</code> , \u4F7F\u7528\u6846\u67B6 <code>\\Poppy\\Framework\\Application\\RouteServiceProvider</code> \u66FF\u4EE3</p><p>\u79FB\u9664 <code>\\Poppy\\System\\Action\\Pam::passportType</code> , \u4F7F\u7528 <code>PamAccount::passportType()</code> \u66FF\u4EE3</p><p>\u79FB\u9664 <code>\\Poppy\\System\\Action\\Verification::getHiddenStr</code> , \u4F7F\u7528 <code>\\Poppy\\System\\Action\\Verification::getHidden</code> \u66FF\u4EE3, \u56E0\u4E3A\u8FD4\u56DE\u4E0D\u4EC5\u4EC5\u662F\u5B57\u4E32, \u53EF\u80FD\u8FD8\u4F1A\u6709\u6570\u7EC4</p><p>\u79FB\u9664 <code>\\Poppy\\System\\Tests\\Base\\SystemTestCase::export</code> , \u4F7F\u7528 <code>\\Poppy\\Framework\\Application\\TestCase::outputVariables</code> \u66FF\u4EE3, \u4F7F\u7528 stream \u6253\u5370\u6570\u636E, \u53EF\u4FDD\u8BC1\u8FD0\u884C\u65E0\u5F02\u5E38\u63D0\u793A</p><p>\u79FB\u9664 <code>\\Poppy\\System\\Events\\LoginSuccessEvent</code> \u7684 platform \u53C2\u6570, \u4F7F\u7528 <code>x-id</code> \u66FF\u4EE3</p><p>\u7EE7\u627F\u9879\u76EE <code>\\Poppy\\System\\Http\\Forms\\Settings\\FormSettingBase</code> \u66F4\u65B0\u4E3A <code>Poppy\\MgrPage\\Classes\\Form\\FormSettingBase</code>, \u540C\u7406 Grid \u4E5F\u4F1A\u8FC1\u79FB, \u8FD9\u91CC\u662F\u5BF9\u9875\u9762\u7684\u7EC4\u7EC7\u5BF9 mgr-page \u505A\u7684\u4E00\u4E2A\u8C03\u6574</p><p><strong>services \u94A9\u5B50\u6539\u52A8</strong></p><p>\u79FB\u9664 <code>poppy.system.html_top_nav</code> \u66F4\u6539\u4E3A <code>poppy.mgr-page.html_top_nav</code> \u5E76\u79FB\u52A8\u5230 mgr-page \u4E2D</p><p>\u79FB\u9664 <code>poppy.system.html_cp</code> \u66F4\u6539\u4E3A <code>poppy.mgr-page.html_cp</code> \u5E76\u79FB\u52A8\u5230 mgr-page \u4E2D</p><p>\u79FB\u9664 <code>poppy.system.settings</code> \u66F4\u6539\u4E3A <code>poppy.mgr-page.settings</code> \u5E76\u79FB\u52A8\u5230 mgr-page \u4E2D</p><p>\u79FB\u9664 <code>poppy.system.custom_settings</code>, \u6B64\u670D\u52A1\u5E76\u5165 <code>poppy.mgr-page.settings</code></p><ul><li><strong>\u63A5\u53E3</strong></li></ul><p>\u63A5\u53E3\u9700\u8981\u589E\u52A0\u6807\u51C6\u5316\u53C2\u6570 <code>x-type</code> \u7528\u6765\u6307\u5B9A\u662F\u524D\u53F0\u7528\u6237\u8FD8\u662F\u540E\u53F0\u7528\u6237, \u9ED8\u8BA4\u662F <code>user</code></p><ul><li><strong>\u91CD\u590D</strong></li></ul><p>\u79FB\u9664 <code>JwtAuthGuard</code> , \u548C Jwt \u5305\u6570\u636E\u91CD\u590D</p><ul><li><strong>\u79FB\u9664</strong></li></ul><p>\u79FB\u9664 <code>PamAccount-&gt;getJWTCustomClaims()</code> \u7684 <code>user.id</code> \u8FD4\u56DE, \u6539\u8FD4\u56DE\u548C jwt \u7684 <code>sub</code> \u4E00\u81F4, \u4E0D\u5FC5\u518D\u591A\u4F59\u8FD4\u56DE, \u65E0\u517C\u5BB9\u6027\u95EE\u9898</p><h2 id="aliyun-oss" tabindex="-1"><a class="header-anchor" href="#aliyun-oss" aria-hidden="true">#</a> Aliyun-Oss</h2><ul><li><strong>\u53EF\u66FF\u4EE3</strong></li></ul><p>\u79FB\u9664 <code>Action/ActSts</code> \u7C7B, \u4F7F\u7528 <code>Sts</code> \u7C7B, \u4EC5\u4EC5\u6539\u52A8\u547D\u540D</p><p>\u79FB\u9664 <code>Action/OssDefaultUploadProvider</code>, \u4F7F\u7528 <code>Classes\\Provider\\OssDefaultUploadProvider</code>, \u82E5\u4F9D\u8D56\u4E8E 4.0 \u7EC4\u4EF6\u5219\u6B64\u95EE\u9898\u4E0D\u5FC5\u5173\u6CE8.</p><h2 id="mgrpage" tabindex="-1"><a class="header-anchor" href="#mgrpage" aria-hidden="true">#</a> MgrPage</h2><ul><li><strong>\u53EF\u66FF\u4EE3</strong></li></ul><p>\u79FB\u9664 <code>\\Poppy\\MgrPage\\Classes\\Form\\Field\\Number</code> \u7684 <code>min</code> \u548C <code>max</code> \u65B9\u6CD5, \u4F7F\u7528\u540E\u7AEF\u670D\u52A1\u89C4\u5219\u6821\u9A8C <code>Rule::min</code>, <code>Rule::max</code></p>`,70),c=[a];function p(i,t){return s(),o("div",null,c)}const r=e(n,[["render",p],["__file","upgrade.html.vue"]]);export{r as default};
